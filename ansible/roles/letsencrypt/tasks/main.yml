---
- name: Add PPA for certbot
  apt_repository:
    repo: 'ppa:certbot/certbot'
    state: present
    update_cache: true
  become: true

- name: Install certbot
  apt:
    name: "{{ item }}"
    state: present
    update_cache: true
  with_items:
    - certbot
    - python-certbot-apache
  become: true

- name: Make cli.ini file
  copy:
    src: cli.ini
    dest: /etc/letsencrypt/cli.ini
    mode: 0644
    group: root
    owner: root
  become: true

- name: Make directories for hooks
  file:
    path: "/etc/letsencrypt/renewal-hooks/{{ item }}"
    state: directory
    mode: 0755
    owner: root
    group: root
    recurse: true
  with_items:
    - pre
    - post
    - deploy
  become: true

- name: Make directories for hooks
  file:
    path: "/etc/letsencrypt/renewal/"
    state: directory
    mode: 0755
    owner: root
    group: root
  become: true

- name: Make renewal hooks
  copy:
    src: apache.sh
    dest: /etc/letsencrypt/renewal-hooks/
    mode: 0755
    owner: root
    group: root
  become: true

- name: Make renewal job
  copy:
    src: cert-renew.sh
    dest: /etc/cron.daily/cert-renew.sh
    owner: root
    group: root
    mode: 0755
  become: true

- name: Get www certificate
  command: certbot certonly -d www.comicwiki.dk -d comicwiki.dk
  args:
    creates: /etc/letsencrypt/live/www.comicwiki.dk
  become: true

- name: Adjust renewal interval for certificate
  lineinfile:
    path: /etc/letsencrypt/renewal/www.comicwiki.dk.conf
    regexp: '^renew_before_expiry'
    line: 'renew_before_expiry = 7 days'
  become: true
